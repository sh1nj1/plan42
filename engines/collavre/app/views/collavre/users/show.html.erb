<% active_tab = @active_tab || "profile" %>

<h1 class="no-top-margin"><%= t('collavre.users.details') %></h1>

<div data-controller="tabs" data-tabs-active-tab-value="<%= active_tab %>">
  <div class="tab-list">
    <button class="tab-button <%= 'active' if active_tab == 'profile' %>" data-action="click->tabs#switch" data-tabs-tab-param="profile" data-tabs-target="tabButton">
      <%= t('collavre.users.tabs.profile') %>
    </button>
    <button class="tab-button <%= 'active' if active_tab == 'contacts' %>" data-action="click->tabs#switch" data-tabs-tab-param="contacts" data-tabs-target="tabButton">
      <%= t('collavre.users.tabs.user_management') %>
    </button>
  </div>

<div class="tab-panels">
  <section class="tab-panel <%= 'active' if active_tab == 'profile' %>" data-tabs-target="panel" data-tab-name="profile">

    <% if @user.ai_user? %>
      <div class="ai-user-details">
        <div class="alert alert-info">
          <%= t('collavre.users.details_ai_notice') %>
          <%= link_to t('collavre.users.edit_ai.title'), collavre.edit_ai_user_path(@user), class: "btn btn-sm btn-primary ml-2" %>
        </div>

        <dl class="row">
          <dt class="col-sm-3"><%= t('collavre.users.name') %></dt>
          <dd class="col-sm-9"><%= @user.name %></dd>

          <dt class="col-sm-3"><%= t('collavre.users.new_ai.id_label') %></dt>
          <dd class="col-sm-9"><%= @user.email.split('@').first %></dd>

          <dt class="col-sm-3"><%= t('collavre.users.new_ai.model_label') %></dt>
          <dd class="col-sm-9"><%= @user.llm_model %></dd>

          <dt class="col-sm-3"><%= t('collavre.users.new_ai.system_prompt_label') %></dt>
          <dd class="col-sm-9"><pre><%= @user.system_prompt %></pre></dd>
        </dl>
      </div>
    <% else %>
      <div data-controller="avatar-preview">

        <div class="avatar-preview-row">
          <div class="avatar-preview-pane avatar-preview-current">
            <span class="avatar-preview-label"><%= t('collavre.users.current_avatar') %></span>
            <%= render AvatarComponent.new(user: @user, size: 80, classes: 'avatar') %>
          </div>

          <div class="avatar-preview-pane avatar-preview-container" data-avatar-preview-target="previewContainer">
            <span class="avatar-preview-label"><%= t('collavre.users.new_avatar_preview') %></span>
            <div class="avatar-preview-frame">
              <%= image_tag '',
                            alt: t('collavre.users.new_avatar_preview'),
                            class: 'avatar-preview-image avatar-preview-hidden',
                            data: { avatar_preview_target: 'previewImage' } %>
            </div>
          </div>
        </div>

      <%= form_with model: @user, url: collavre.user_path(@user), method: :patch, local: true, html: { multipart: true, class: 'profile-form' } do |f| %>
        <div>
          <%= f.label :avatar, t('collavre.users.avatar') %>
          <%= f.file_field :avatar, data: { avatar_preview_target: 'input', action: 'change->avatar-preview#update' } %>
        </div>
        <div>
          <%= f.label :name, t('collavre.users.name') %>
          <%= f.text_field :name, required: true %>
        </div>
        <div>
          <%= f.label :email, t('collavre.users.email') %>
          <%= f.text_field :email, required: true, disabled: true %>
        </div>
        <div>
          <%= f.label :avatar_url, t('collavre.users.avatar_url') %>
          <%= f.text_field :avatar_url, placeholder: t('collavre.users.avatar_url'), data: { avatar_preview_target: 'urlInput', action: 'input->avatar-preview#updateFromUrl' } %>
        </div>
        <div>
          <%= f.label :display_level, t('collavre.users.display_level') %>
          <%= f.number_field :display_level, min: 1 %>
        </div>
        <div>
          <%= f.label :completion_mark, t('collavre.users.completion_mark') %>
          <%= f.text_field :completion_mark %>
        </div>
        <div>
        <div>
          <%= f.label :theme, t('collavre.users.theme') %>
          <%
             theme_options = [[t('app.system_mode'), nil], [t('app.light_mode'), 'light'], [t('app.dark_mode'), 'dark']]
             theme_options += @user.user_themes.map { |ut| [ut.name, ut.id.to_s] }
          %>
          <%= f.select :theme, options_for_select(theme_options, @user.theme), {}, style: "width: 100%; display: block;" %>
          <div style="margin-top: 5px;">
            <a href="<%= collavre.user_themes_path %>" style="font-size: 0.9em;"><%= t("collavre.themes.manage") %></a>
          </div>
        </div>
        <div>
          <%= f.label :calendar_id, t('collavre.users.calendar_id') %>
          <%= f.text_field :calendar_id, placeholder: t('collavre.users.calendar_id') %>
        </div>
        <div class="checkbox-field">
          <%= f.check_box :notifications_enabled %>
          <%= f.label :notifications_enabled, t('collavre.users.notifications_enabled') %>
        </div>
        <div>
          <%= f.label :locale, t('collavre.users.locale') %>
          <%= f.select :locale, I18n.available_locales.map { |loc| [t("collavre.users.locales.#{loc}"), loc] } %>
        </div>
        <div>
          <%= f.label :timezone, t('collavre.users.timezone') %>
          <%= f.select :timezone, ActiveSupport::TimeZone.all.map { |tz| [tz.to_s, tz.tzinfo.name] } %>
        </div>
        <%= f.submit t('collavre.users.update_profile') %>
      <% end %>

      <div class="profile-actions">
        <%= link_to t('collavre.users.change_password'), collavre.edit_password_user_path(@user) %>
        <br>
        <%= link_to t('collavre.users.webauthn.manage'), collavre.passkeys_user_path(@user) %>
        <br>
        <%= link_to t('doorkeeper.my_applications'), main_app.oauth_applications_path %>
        <% if @user.system_admin? %>
          <br>
          <%= link_to t('admin.title'), main_app.admin_path %>
        <% end %>
      </div>


      </div>
    <% end %>
  </section>

    <section class="tab-panel <%= 'active' if active_tab == 'contacts' %>" data-tabs-target="panel" data-tab-name="contacts">
      <%= render partial: 'collavre/users/contact_management', locals: {
        contacts: @contacts,
        last_login_map: @last_login_map,
        shared_by_me: @shared_by_me,
        shared_with_me: @shared_with_me,
        contact_page: @contact_page,
        total_contact_pages: @total_contact_pages
      } %>
    </section>
  </div>
</div>
