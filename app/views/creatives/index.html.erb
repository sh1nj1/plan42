<%= tag.div(flash[:alert], class: "flash-alert") if flash[:alert] %>

<div class="creative-actions-row">
  <%= render 'add_button' if authenticated? && (!params[:id] || (@parent_creative && @parent_creative.has_permission?(Current.user, :write))) %>
  <% if @parent_creative&.parent_id.present? %>
    <%= button_to creative_path(@parent_creative.owning_parent), method: :get, aria: { label: t('.up') } do %>
      <span aria-hidden="true"><%= svg_tag 'arrow-up.svg', class: 'icon-up', width: 16, height: 16 %></span>
    <% end %>
  <% elsif @parent_creative.present? %>
    <%= button_to creatives_path, class: "up-link", method: :get, aria: { label: t('.up') } do %>
      <span aria-hidden="true"><%= svg_tag 'arrow-up.svg', class: 'icon-up', width: 16, height: 16 %></span>
    <% end %>
  <% end %>

  <% if (@parent_creative || @creative) && (@parent_creative || @creative).has_permission?(Current.user, :write) %>
    <%= render 'share_button' %>
  <% end %>

  <% current_creative = @parent_creative || @creative %>
  <% if current_creative&.has_permission?(Current.user, :write) %>
    <%= render PopupMenuComponent.new(
          button_content: t('creatives.index.integrations', default: 'ì—°ë™'),
          menu_id: 'creative-integrations-menu',
          align: :left,
          button_classes: 'desktop-only'
        ) do %>
      <button type="button" class="popup-menu-item" data-click-target="github-integration-btn">Github</button>
    <% end %>
  <% end %>

  <% if @parent_creative.present? %>
    <%= button_to slide_view_creative_path(@parent_creative), method: :get, class: 'slide-view-btn desktop-only', aria: { label: t('creatives.index.slide_view') } do %>
      <span aria-hidden="true"><%= svg_tag 'slide.svg', class: 'icon-slide', width: 22, height: 20 %></span>
    <% end %>
  <% end %>

  <button id="set-plan-btn" class="set-plan-btn" style="display:none;"><%= t('app.set_plan') %></button>
  <input type="checkbox" id="select-all-creatives" style="display:none;vertical-align:middle;" />
  <button id="select-creative-btn" class="select-btn" data-select-text="<%= t('app.select') %>" data-cancel-text="<%= t('app.cancel_select') %>"><%= t('app.select') %></button>
  <% if (@parent_creative || @creative)&.has_permission?(Current.user, :admin) %>
    <button id="delete-selection-btn" class="danger-link" style="display:none;" data-confirm="<%= t('creatives.index.are_you_sure_delete_selection') %>"><%= t('creatives.index.delete_selection') %></button>
  <% end %>
  <button id="expand-all-btn" class="expand-btn" style="width: 36px;" data-expand-text="<%= t('app.expand_all') %>" data-collapse-text="<%= t('app.collapse_all') %>" ><span aria-hidden="true">â–¼</span></button>
  <button id="toggle-edit-btn" class="edit-toggle-btn mobile-only" aria-label="<%= t('.edit') %>" title="<%= t('.edit') %>">
    <span aria-hidden="true"><%= svg_tag 'edit.svg', class: 'icon-edit', width: 16, height: 16 %></span></button>
  <button id="import-markdown-btn" class="import-btn desktop-only"><%= t('.import_markdown') %></button>
  <button id="export-markdown-btn" class="export-btn desktop-only" data-parent-creative-id="<%= @parent_creative&.id %>" data-error="<%= t('creatives.index.export_failed') %>"><%= t('.export_markdown') %></button>
  <%= render 'mobile_actions_menu' %>
</div>
<%= render 'import_upload_zone' %>
<button id="github-integration-btn" data-creative-id="<%= current_creative&.id %>" style="display:none;"></button>

<%#= TODO: remove this later completely recalculate progress you need to remove route, and controller also %>
<%#= button_to t('.recalculate_progress'), recalculate_progress_creatives_path, method: :post, form: { data: { turbo_confirm: t('.recalculate_all_parent_progress') } } if authenticated? %>

<%= stylesheet_link_tag 'comments_popup', media: 'all' %>
<%= stylesheet_link_tag 'mention_menu', media: 'all' %>

<div class="tags">
  <% labels = @parent_creative&.tags&.map { |tag| tag.label }&.compact %>
  <% labels&.each do |label| %>
    <input type="checkbox" class="tag-checkbox"
           <%= "checked" unless params[:tags].present? && params[:tags].include?(label.id.to_s) %>
           value="<%= label.id %>">

      <%= "##{label.name}" %>
      <% if label.type == "Plan" %> ðŸ—“<%= label.target_date %><% end %>

  <% end %>
  <% if labels.present? %>
  <button id="apply-tags"><%= t('app.apply_tags') %></button>
  <% end %>
</div>

<% if @parent_creative %>
  <% content_for :head do %>
    <meta property="og:title" content="<%= @parent_creative.effective_origin.description.to_plain_text %>">
  <% end %>
  <% title_templates = [
        content_tag(:template, data: { part: "description" }) { @parent_creative.effective_description },
        content_tag(:template, data: { part: "progress" }) { render_creative_progress(@parent_creative) }
      ] %>
  <% if @parent_creative.origin_id.present? %>
    <% title_templates << content_tag(:template, data: { part: "origin-link" }) do %>
      <%= link_to creative_path(@parent_creative.origin),
                  class: "creative-origin-link creative-action-btn unstyled-link",
                  title: t("creatives.index.view_origin"),
                  aria: { label: t("creatives.index.view_origin") } do %>
        <%= svg_tag "arrow-right.svg", class: "creative-origin-link-icon", width: 16, height: 16 %>
      <% end %>
    <% end %>
  <% end %>
  <%= content_tag(
        "creative-tree-row",
        safe_join(title_templates),
        "dom-id": "creative-markdown-block",
        "creative-id": @parent_creative.id,
        "parent-id": @parent_creative.parent_id,
        "is-title": ""
      ) %>
<% else %>
  <%= content_tag(
        "creative-tree-row",
        content_tag(:template, data: { part: "description" }) do
          if params[:tags].present?
            render_tags(params[:tags]&.map { |tag_id| Label.find(tag_id) }, "unstyled-link")
          else
            t('.creatives')
          end
        end +
        content_tag(:template, data: { part: "progress" }) do
          if @overall_progress.nil?
            "".html_safe
          else
            render_progress_value(@overall_progress)
          end
        end,
        "dom-id": "creative-markdown-block",
        "is-title": ""
      ) %>
<% end %>

<div id="creatives">
  <% if @creatives.present? %>
    <%= render_creative_tree(@creatives, 1, select_mode: false, max_level: Current.user&.display_level || User::DEFAULT_DISPLAY_LEVEL) %>
  <% else %>
    <% if params[:search].present? %>
      <p style="text-align: center;"><%= t('.no_search_results') %></p>
    <% elsif params[:id] && @creative && !@creative.has_permission?(Current.user, :read) %>
      <p style="text-align: center;"><%= t('.no_permission') %></p>
      <div style="text-align: center;">
        <%= button_to t('.request_permission'), request_permission_creative_path(@creative), method: :post %>
      </div>
    <% else %>
      <p style="text-align: center;"><%= params[:id] ? t('.no_sub_creatives') : t('.no_creatives') %></p>
    <% end %>
  <% end %>
</div>

<%= render 'comments/comments_popup' %>
<%= render 'inline_edit_form' %>

<%= render 'set_plan_modal' %>
<%= render 'github_integration_modal', creative: current_creative %>
