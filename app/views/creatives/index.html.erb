<%= tag.div(flash[:alert], class: "flash-alert") if flash[:alert] %>

<div data-controller="creatives--import creatives--select-mode creatives--drag-drop creatives--expansion creatives--row-editor creatives--set-plan-modal"
     data-creatives--import-parent-id-value="<%= @parent_creative&.id %>"
     data-creatives--import-uploading-value="<%= t('creatives.index.import_uploading') %>"
     data-creatives--import-success-value="<%= t('creatives.index.import_success') %>"
     data-creatives--import-failed-value="<%= t('creatives.index.import_failed') %>"
     data-creatives--import-only-markdown-value="<%= t('creatives.index.only_markdown') %>"
     data-creatives--set-plan-modal-select-one-value="<%= t('creatives.index.select_one_creative') %>"
     data-creatives--set-plan-modal-select-plan-value="<%= t('creatives.index.select_plan_to_remove') %>">
  <div class="creative-actions-row">
  <%= render 'add_button' if authenticated? && (!params[:id] || (@parent_creative && @parent_creative.has_permission?(Current.user, :write))) %>
  <% if @parent_creative&.parent_id.present? %>
    <%= button_to creative_path(@parent_creative.owning_parent), method: :get, aria: { label: t('.up') } do %>
      <span aria-hidden="true"><%= svg_tag 'arrow-up.svg', class: 'icon-up', width: 16, height: 16 %></span>
    <% end %>
  <% elsif @parent_creative.present? %>
    <%= button_to creatives_path, class: "up-link", method: :get, aria: { label: t('.up') } do %>
      <span aria-hidden="true"><%= svg_tag 'arrow-up.svg', class: 'icon-up', width: 16, height: 16 %></span>
    <% end %>
  <% end %>

  <% current_creative = @parent_creative || @creative %>
  <% can_manage_integrations = current_creative&.has_permission?(Current.user, :admin) %>
  <% if (@parent_creative || @creative) && (@parent_creative || @creative).has_permission?(Current.user, :write) %>
    <%= render 'share_button' %>
  <% end %>

  <% if can_manage_integrations %>
    <%= render PopupMenuComponent.new(
          button_content: t('creatives.index.integrations', default: 'ì—°ë™'),
          menu_id: 'creative-integrations-menu',
          align: :left,
          button_classes: 'desktop-only'
        ) do %>
      <button type="button" class="popup-menu-item" data-controller="click-target" data-click-target-id-value="github-integration-btn" data-action="click->click-target#trigger">Github</button>
       <button type="button" class="popup-menu-item" data-controller="click-target" data-click-target-id-value="notion-integration-btn" data-action="click->click-target#trigger">Notion</button>
    <% end %>
  <% end %>

  <% if @parent_creative.present? %>
    <%= button_to slide_view_creative_path(@parent_creative), method: :get, class: 'slide-view-btn desktop-only', aria: { label: t('creatives.index.slide_view') } do %>
      <span aria-hidden="true"><%= svg_tag 'slide.svg', class: 'icon-slide', width: 22, height: 20 %></span>
    <% end %>
  <% end %>

  <button id="set-plan-btn" class="set-plan-btn" style="display:none;" data-creatives--select-mode-target="setPlan" data-action="click->creatives--set-plan-modal#open"><%= t('app.set_plan') %></button>
  <input type="checkbox" id="select-all-creatives" style="display:none;vertical-align:middle;" data-action="change->creatives--select-mode#toggleSelectAll" data-creatives--select-mode-target="selectAll" />
  <button id="select-creative-btn" class="select-btn" data-select-text="<%= t('app.select') %>" data-cancel-text="<%= t('app.cancel_select') %>" data-action="click->creatives--select-mode#toggle" data-creatives--select-mode-target="toggle"><%= t('app.select') %></button>
  <% if (@parent_creative || @creative)&.has_permission?(Current.user, :admin) %>
    <button id="delete-selection-btn" class="danger-link" style="display:none;" data-confirm="<%= t('creatives.index.are_you_sure_delete_selection') %>" data-action="click->creatives--select-mode#deleteSelected" data-creatives--select-mode-target="deleteButton"><%= t('creatives.index.delete_selection') %></button>
  <% end %>
  <button id="expand-all-btn" class="expand-btn" style="width: 36px;" data-expand-text="<%= t('app.expand_all') %>" data-collapse-text="<%= t('app.collapse_all') %>" data-action="click->creatives--expansion#toggleAll" data-creatives--expansion-target="expand"><span aria-hidden="true">â–¼</span></button>
  <button id="toggle-edit-btn" class="edit-toggle-btn mobile-only" aria-label="<%= t('.edit') %>" title="<%= t('.edit') %>">
    <span aria-hidden="true"><%= svg_tag 'edit.svg', class: 'icon-edit', width: 16, height: 16 %></span></button>
  <button id="import-markdown-btn" class="import-btn desktop-only" data-action="click->creatives--import#toggle" data-creatives--import-target="toggle"><%= t('.import_markdown') %></button>
  <button id="export-markdown-btn" class="export-btn desktop-only" data-parent-creative-id="<%= @parent_creative&.id %>" data-error="<%= t('creatives.index.export_failed') %>"><%= t('.export_markdown') %></button>
  <%= render 'mobile_actions_menu', current_creative: current_creative, can_manage_integrations: can_manage_integrations %>
</div>
  <%= render 'import_upload_zone' %>

<% if can_manage_integrations %>
  <button id="github-integration-btn" data-creative-id="<%= current_creative&.id %>" style="display:none;"></button>
  <button id="notion-integration-btn" data-creative-id="<%= current_creative&.id %>" style="display:none;"></button>
<% end %>



<%= stylesheet_link_tag 'comments_popup', media: 'all' %>
<%= stylesheet_link_tag 'mention_menu', media: 'all' %>

<div class="tags">
  <% labels = @parent_creative&.tags&.map { |tag| tag.label }&.compact %>
  <% labels&.each do |label| %>
    <input type="checkbox" class="tag-checkbox"
           <%= "checked" unless params[:tags].present? && params[:tags].include?(label.id.to_s) %>
           value="<%= label.id %>">

      <%= "##{label.name}" %>
      <% if label.type == "Plan" %> ðŸ—“<%= label.target_date %><% end %>

  <% end %>
  <% if labels.present? %>
  <button id="apply-tags"><%= t('app.apply_tags') %></button>
  <% end %>
</div>

<% if @parent_creative %>
  <% content_for :head do %>
    <meta property="og:title" content="<%= strip_tags(@parent_creative.effective_origin.description) %>">
  <% end %>
  <% title_templates = [
        content_tag(:template, data: { part: "description" }) { sanitize @parent_creative.effective_description },
        content_tag(:template, data: { part: "progress" }) { render_creative_progress(@parent_creative) }
      ] %>
  <% if @parent_creative.origin_id.present? %>
    <% title_templates << content_tag(:template, data: { part: "origin-link" }) do %>
      <%= link_to creative_path(@parent_creative.origin),
                  class: "creative-origin-link creative-action-btn unstyled-link",
                  title: t("creatives.index.view_origin"),
                  aria: { label: t("creatives.index.view_origin") } do %>
        <%= svg_tag "arrow-right.svg", class: "creative-origin-link-icon", width: 16, height: 16 %>
      <% end %>
    <% end %>
  <% end %>
  <%= content_tag(
        "creative-tree-row",
        safe_join(title_templates),
        "dom-id": "creative-markdown-block",
        "creative-id": @parent_creative.id,
        "parent-id": @parent_creative.parent_id,
        "is-title": ""
      ) %>
<% else %>
  <%= content_tag(
        "creative-tree-row",
        content_tag(:template, data: { part: "description" }) do
          if params[:tags].present?
            render_tags(params[:tags]&.map { |tag_id| Label.find(tag_id) }, "unstyled-link")
          else
            t('.creatives')
          end
        end +
        content_tag(:template, data: { part: "progress" }) do
          if @overall_progress.nil?
            "".html_safe
          else
            render_progress_value(@overall_progress)
          end
        end,
        "dom-id": "creative-markdown-block",
        "is-title": ""
      ) %>
<% end %>

<%
  empty_html = nil
  if (@creatives || []).blank?
    if params[:search].present?
      empty_html = content_tag(:p, t('.no_search_results'), style: 'text-align: center;')
    elsif params[:id] && @creative && !@creative.has_permission?(Current.user, :read)
      message = content_tag(:p, t('.no_permission'), style: 'text-align: center;')
      action = content_tag(:div, button_to(t('.request_permission'), request_permission_creative_path(@creative), method: :post), style: 'text-align: center;')
      empty_html = message + action
    else
      text = params[:id] ? t('.no_sub_creatives') : t('.no_creatives')
      empty_html = content_tag(:p, text, style: 'text-align: center;')
    end
  end
  tree_params = request.query_parameters.merge(format: :json)
  tree_url = creatives_path(tree_params)
%>

<%= tag.div(
      empty_html,
      id: 'creatives',
      data: {
        controller: 'creatives--tree',
        'creatives--tree-url-value': tree_url,
        'creatives--tree-empty-html-value': empty_html.to_s,
        edit_icon_html: svg_tag("edit.svg", className: "icon-edit"),
        edit_off_icon_html: svg_tag("edit-off.svg", className: "icon-edit")
      }
    ) %>

<%= render 'comments/comments_popup' %>
<%= render 'inline_edit_form' %>

<%= render 'set_plan_modal' %>
<% if can_manage_integrations %>
  <%= render 'github_integration_modal', creative: current_creative %>
  <%= render 'notion_integration_modal', creative: current_creative %>
<% end %>
</div>
