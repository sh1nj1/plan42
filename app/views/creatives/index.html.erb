<div class="creative-actions-row">
  <% if @parent_creative&.parent_id.present? %>
    <%= link_to t('.up'), creative_path(@parent_creative.owning_parent), class: "back-link" %>
  <% elsif @parent_creative.present? %>
    <%= link_to t('.up'), creatives_path, class: "up-link" %>
  <% end %>
  
  <%= link_to t('.new_creative'), new_creative_path if authenticated? and not params[:id] %>
  <% if (@parent_creative || @creative) && (@parent_creative || @creative).has_permission?(Current.user, :write) %>
    <%= render 'share_button' %>
  <% end %>
  
  <% if authenticated? && @parent_creative && @parent_creative.has_permission?(Current.user, :write) %>
    <%= link_to t('.new_sub_creative'), @parent_creative&.id ? new_creative_path(parent_id: @parent_creative.id) : new_creative_path %>
    <%= link_to t('.edit'), edit_creative_path(@parent_creative) %>
    <%= link_to t('.append_as_parent_creative'), append_as_parent_creative_creatives_path(parent_id: @parent_creative&.id), class: 'btn btn-secondary' %>

    <%= render 'delete_button' %>

  <% end %>
  <% if params[:select_mode].present? %>
    <button id="set-plan-btn" class="set-plan-btn"><%= t('app.set_plan') %></button>
    <input type="checkbox" id="select-all-creatives" style="margin-left:1em;vertical-align:middle;" />
  <% end %>
  <button id="select-creative-btn" class="select-btn"><%= t('app.select') %></button>
  <button id="import-markdown-btn" class="import-btn"><%= t('.import_markdown') %></button>
</div>
<%= render 'import_upload_zone' %>

<%#= TODO: remove this later completely recalculate progress you need to remove route, and controller also %>
<%#= button_to t('.recalculate_progress'), recalculate_progress_creatives_path, method: :post, form: { data: { turbo_confirm: t('.recalculate_all_parent_progress') } } if authenticated? %>

<% if @parent_creative %>
  <div class="creative-row">
    <h1 class="page-title" style="display:flex;align-items:center;gap:1em;">
      <%= @parent_creative.effective_description %>
    </h1>
    <h1>
      <%= render_creative_progress(@parent_creative) %>
    </h1>
  </div>
<% else %>
  <div class="creative-row">
    <h1 class="page-title"><%= t('.creatives') %></h1>
  </div>
<% end %>

<div id="creatives">
  <% if @creatives %>
    <% select_mode = params[:select_mode].present? %>
    <%= render_creative_tree(@creatives, 1, select_mode: select_mode) %>
  <% else %>
    <p style="text-align: center;"><%= params[:id] ? t('.no_sub_creatives') : t('.no_creatives') %></p>
  <% end %>
</div>

<%= render 'set_plan_modal' %>

<%= javascript_include_tag 'creatives_drag_drop', defer: true %>
<%= javascript_include_tag 'creatives_import', defer: true %>
<%= javascript_include_tag 'creatives_expansion', defer: true %>

<script>
  document.addEventListener('turbo:load', function() {
    var selectBtn = document.getElementById('select-creative-btn');
    if (!selectBtn) return;
    selectBtn.addEventListener('click', function() {
      var url = new URL(window.location.href);
      if (url.searchParams.get('select_mode')) {
        url.searchParams.delete('select_mode');
      } else {
        url.searchParams.set('select_mode', '1');
      }
      window.location.href = url.toString();
    });
    // Change button text if in select mode
    if (window.location.search.includes('select_mode')) {
      selectBtn.textContent = '<%= t("app.cancel_select") %>';
    }
  });
</script>

<script>
  document.addEventListener('turbo:load', function() {
    var selectAll = document.getElementById('select-all-creatives');
    if (selectAll) {
      selectAll.addEventListener('change', function() {
        var boxes = document.querySelectorAll('.select-creative-checkbox');
        boxes.forEach(function(cb) { cb.checked = selectAll.checked; });
      });
    }
  });
</script>
