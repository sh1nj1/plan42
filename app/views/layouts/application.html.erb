<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || t('app.name') %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="app-version" content="<%= Rails.application.config.app_version %>">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <% if Current.user %>
      <meta name="notifications-enabled" content="<%= Current.user.notifications_enabled %>">
    <% end %>

    <% if Rails.application.config.x.firebase_config.present? %>
      <script>
        window.firebaseConfig = <%= Rails.application.config.x.firebase_config.to_json.html_safe %>
      </script>
    <% end %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%= tag.link rel: "manifest", href: main_app.pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon-1e3cf549d2.png" type="image/png">
    <link rel="icon" href="/icon-1e3cf549d2.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon-1e3cf549d2.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag :dark_mode %>
    <%= stylesheet_link_tag :print, media: 'print' %>
    <%= stylesheet_link_tag 'user_menu' %>
    <%= stylesheet_link_tag 'popup' %>

    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true, type: "module" %>
  </head>
    <% if Current.user&.theme.present? && !%w[light dark].include?(Current.user.theme) %>
      <% if (custom_theme = UserTheme.find_by(id: Current.user.theme)) %>
        <style id="user-theme-styles" data-turbo-track="reload">
          body {
            <% custom_theme.variables.each do |key, value| %>
              <%= key %>: <%= value %> !important;
            <% end %>
          }
        </style>
      <% end %>
    <% end %>
  <body class="<%= 'dark-mode' if Current.user&.theme == 'dark' %><%= ' light-mode' if Current.user&.theme == 'light' %>" data-current-user-id="<%= Current.user&.id %>" data-controller="action-text-attachment-link" data-action="click->action-text-attachment-link#download">
    <%= render 'shared/link_creative_modal' %>
    <%= turbo_stream_from ["inbox", Current.user] if Current.user %>
    <div class="notice"><%= notice %></div>

    <nav>
      <form action="<%= main_app.creatives_path %>" method="get">
        <% if params[:id].present? %>
          <input type="hidden" name="id" value="<%= params[:id] %>" />
        <% end %>
        <input type="text" id="search" class="shared-input-surface" name="search" value="<%= params[:search] %>" placeholder="<%= t('app.search_placeholder') %>" />
      </form>
      <% if authenticated? %>
        <button class="plans-menu-btn mobile-only" type="button"><%= t('app.plans') %></button>
      <% end %>

      <div class="desktop-only">
        <%= button_to t('app.home'), main_app.root_path, method: :get %>
        <% if authenticated? %>
          <form id="button_to">
            <button id="plans-menu-btn" class="plans-menu-btn" type="button"><%= t('app.plans') %></button>
          </form>
          <% progress_state = if params[:min_progress] == '1' && params[:max_progress] == '1'
                                :complete
                              elsif params[:min_progress] == '0' && params[:max_progress] == '0.99'
                                :incomplete
                              else
                                :all
                              end %>
          <% comment_state = params[:comment] == 'true' ? :comment : nil %>
          <%= render ProgressFilterComponent.new(
                current_state: progress_state,
                states: [
                  { name: t('app.filter_complete'), value: :complete },
                  { name: t('app.filter_incomplete'), value: :incomplete },
                  { name: t('app.filter_all'), value: :all }
                ]
              ) %>
          <%= render ProgressFilterComponent.new(
                current_state: comment_state,
                states: [
                  { name: t('app.filter_comments'), value: :comment }
                ]
              ) %>
        <% end %>
        <% if Current.user %>
          <form id="inbox_button_to">
            <button id="inbox-menu-btn" class="inbox-menu-btn" type="button"><%= t('app.inbox') %><%= render Inbox::BadgeComponent.new(user: Current.user, badge_id: 'desktop-inbox-badge') %></button>
          </form>
        <% end %>
        <%= button_to t('app.sign_in'), main_app.new_session_path, method: :get unless authenticated? %>
        <%= button_tag "?", id: "creative-guide-link", class: "creative-guide-link", data: { help_url: SystemSetting.help_menu_link } %>
      </div>

      <%= render PopupMenuComponent.new(
            button_content: safe_join(['...', (render(Inbox::BadgeComponent.new(user: Current.user, badge_id: 'mobile-inbox-badge')) if Current.user)]),
            button_classes: 'mobile-only',
            menu_id: 'mobile-more-menu',
            align: :right
          ) do %>
        <div><%= button_to t('app.home'), main_app.root_path, method: :get %></div>
        <% if authenticated? %>
          <% progress_state = if params[:min_progress] == '1' && params[:max_progress] == '1'
                                :complete
                              elsif params[:min_progress] == '0' && params[:max_progress] == '0.99'
                                :incomplete
                              else
                                :all
                              end %>
          <% comment_state = params[:comment] == 'true' ? :comment : nil %>
          <%= render ProgressFilterComponent.new(
                current_state: progress_state,
                states: [
                  { name: t('app.filter_complete'), value: :complete },
                  { name: t('app.filter_incomplete'), value: :incomplete },
                  { name: t('app.filter_all'), value: :all }
                ]
              ) %>
          <%= render ProgressFilterComponent.new(
                current_state: comment_state,
                states: [
                  { name: t('app.filter_comments'), value: :comment }
                ]
              ) %>
        <% end %>
        <% if Current.user %>
          <div>
            <button class="inbox-menu-btn" type="button"><%= t('app.inbox') %><%= render Inbox::BadgeComponent.new(user: Current.user, badge_id: 'mobile-inbox-badge') %></button>
          </div>
        <% end %>
        <div><%= button_to t('app.sign_in'), main_app.new_session_path, method: :get unless authenticated? %></div>
        <div><%= button_tag "?", id: "creative-guide-link", class: "creative-guide-link", data: { help_url: SystemSetting.help_menu_link } %></div>
      <% end %>

      <% if Current.user %>
        <%= render PopupMenuComponent.new(
          button_content: render(AvatarComponent.new(user: Current.user, size: 32, classes: 'nav-avatar avatar')),
          menu_id: 'user-menu',
          align: :right
        ) do %>
          <div><%= button_to t('users.profile'), main_app.user_path(Current.user), class: 'popup-menu-item', method: :get %></div>

          <div><%= button_to t('app.sign_out'), main_app.session_path, method: :delete %></div>
        <% end %>
      <% end %>
    </nav>

    <div id="plans-list-area" style="display:none;">
      <%= render PlansTimelineComponent.new(plans: Plan.none) %>
    </div>

    <div id="inbox-panel" class="slide-panel">
      <div class="inbox-panel-header">
        <button id="close-inbox" type="button">&times;</button>
        <label><input type="checkbox" id="toggle-inbox-read"> <%= t('inbox.show_read') %></label>
      </div>
      <div id="inbox-list" data-loading-text="<%= t('app.loading') %>" data-empty-text="<%= t('inbox.no_messages') %>"></div>
    </div>

    <div id="creative-guide-popover" style="display:none; position:fixed; top:60px; left:50%; transform:translateX(-50%); background:white; border:1px solid var(--color-border); box-shadow:0 2px 8px rgba(0,0,0,0.12); padding:1.2em; max-width:400px; z-index:1000; border-radius:8px;">
      <span style="float:right; cursor:pointer; font-weight:bold;" id="close-creative-guide">&times;</span>
      <div style="margin-top:0.5em; color:#444; font-size:1em; line-height:1.5;">
        <%= t('app.creative_guide') %>
      </div>
    </div>

    <% unless Rails.env.test? %>
    <div id="notification-permission-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1000;align-items:center;justify-content:center;">
      <div class="popup-box" style="max-width:400px;">
        <p><%= t('notifications.permission_prompt') %></p>
        <div style="margin-top:1em;text-align:right;">
          <button id="deny-notifications" data-confirm-message="<%= t('notifications.confirm_deny') %>"><%= t('notifications.deny') %></button>
          <button id="allow-notifications"><%= t('notifications.allow') %></button>
        </div>
      </div>
    </div>
<% end %>

    <script>
      if (!window.isPlansMenuInitialized) {
        window.isPlansMenuInitialized = true;
        document.addEventListener('turbo:load', function() {
          var btns = document.querySelectorAll('.plans-menu-btn');
          var area = document.getElementById('plans-list-area');
          var loaded = false;
          var timeline = document.getElementById('plans-timeline');
          btns.forEach(function(btn) {
            btn.addEventListener('click', function() {
              if (area.style.display === 'none') {
                area.style.display = 'block';
                if (!loaded) {
                  fetch('/plans.json')
                    .then(function(r) { return r.json(); })
                    .then(function(plans) {
                      if (timeline) { timeline.dataset.plans = JSON.stringify(plans); }
                      if (window.initPlansTimeline && timeline) {
                        window.initPlansTimeline(timeline);
                      }
                      loaded = true;
                    });
                }
              } else {
                area.style.display = 'none';
              }
            });
          });
        });
      }
    </script>

    <script>
      if (!window.isInboxMenuInitialized) {
        window.isInboxMenuInitialized = true;
        document.addEventListener('turbo:load', function() {
          var btns = document.querySelectorAll('.inbox-menu-btn');
          var panel = document.getElementById('inbox-panel');
          var list = document.getElementById('inbox-list');
          var closeBtn = document.getElementById('close-inbox');
          var toggle = document.getElementById('toggle-inbox-read');
          if (toggle && localStorage.getItem('inboxShowRead') === '1') {
            toggle.checked = true;
          }
          function updateInboxBadge() {
            var badges = ['desktop-inbox-badge', 'mobile-inbox-badge']
              .map(function(id) { return document.getElementById(id); })
              .filter(function(el) { return el; });
            if (badges.length === 0) return;
            fetch('/inbox/count')
              .then(r => r.json())
              .then(data => {
                badges.forEach(function(badge) {
                  if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                  } else {
                    badge.textContent = '';
                    badge.style.display = 'none';
                  }
                });
              });
          }

          var inboxNextPage = null;
          var inboxIsLoading = false;

          function fetchInboxPage(page, append) {
            if (!list) return Promise.resolve();
            inboxIsLoading = true;
            var params = new URLSearchParams();
            params.set('page', page);
            if (toggle && toggle.checked) {
              params.set('show', 'all');
            }
            return fetch('/inbox?' + params.toString(), { headers: { 'Accept': 'application/json' } })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                var container = list.querySelector('#inbox-items');
                if (!container) {
                  container = document.createElement('div');
                  container.id = 'inbox-items';
                  list.innerHTML = '';
                  list.appendChild(container);
                } else if (!append) {
                  container.innerHTML = '';
                }

                if (data.empty && !append) {
                  container.innerHTML = '';
                  var emptyDiv = document.createElement('div');
                  emptyDiv.className = 'inbox-empty';
                  emptyDiv.textContent = list ? (list.dataset.emptyText || '') : '';
                  container.appendChild(emptyDiv);
                } else if (data.items_html) {
                  if (!append) {
                    container.innerHTML = data.items_html;
                  } else {
                    container.insertAdjacentHTML('beforeend', data.items_html);
                  }
                }

                inboxNextPage = data.next_page;
                container.dataset.nextPage = data.next_page || '';
                attachActions();
                updateInboxBadge();
              })
              .finally(function() {
                inboxIsLoading = false;
              });
          }

          function loadInbox() {
            if (!list) return Promise.resolve();
            inboxNextPage = null;
            inboxIsLoading = false;
            list.textContent = list.dataset.loadingText || '';
            return fetchInboxPage(1, false);
          }

          function maybeLoadMore() {
            if (!panel) return;
            if (inboxIsLoading) return;
            if (!inboxNextPage) return;
            if (panel.scrollTop + panel.clientHeight >= panel.scrollHeight - 50) {
              fetchInboxPage(inboxNextPage, true);
            }
          }

          function attachActions() {
            document.querySelectorAll('.inbox-item .mark-read').forEach(function(b) {
              b.onclick = function() {
                fetch('/inbox/' + b.dataset.id, {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                  },
                  body: JSON.stringify({ state: 'read' })
                }).then(loadInbox);
              };
            });
            document.querySelectorAll('.inbox-item .mark-unread').forEach(function(b) {
              b.onclick = function() {
                fetch('/inbox/' + b.dataset.id, {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                  },
                  body: JSON.stringify({ state: 'new' })
                }).then(loadInbox);
              };
            });
            document.querySelectorAll('.inbox-item .delete-item').forEach(function(b) {
              b.onclick = function() {
                fetch('/inbox/' + b.dataset.id, {
                  method: 'DELETE',
                  headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content }
                }).then(loadInbox);
              };
            });
            document.querySelectorAll('.inbox-item .item-link').forEach(function(a) {
              a.addEventListener('click', function() {
                localStorage.setItem('inboxOpen', '1');
                var item = a.closest('.inbox-item');
                if (item && item.dataset.id) {
                  fetch('/inbox/' + item.dataset.id, {
                    method: 'PATCH',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                    },
                    body: JSON.stringify({ state: 'read' }),
                    keepalive: true
                  });
                }
              });
            });
          }

          function openPanel() {
            if (!panel) return;
            panel.classList.add('open');
            localStorage.setItem('inboxOpen', '1');
            loadInbox();
            document.body.classList.add('no-scroll');
          }

          function closePanel() {
            if (!panel) return;
            panel.classList.remove('open');
            localStorage.removeItem('inboxOpen');
            document.body.classList.remove('no-scroll');
          }

          var startX = null;
          if (panel) {
            panel.addEventListener('touchstart', function(e) {
              startX = e.touches[0].clientX;
            });
            panel.addEventListener('touchend', function(e) {
              if (startX !== null) {
                var diffX = e.changedTouches[0].clientX - startX;
                if (diffX > 50) {
                  closePanel();
                }
              }
              startX = null;
            });
            panel.addEventListener('scroll', maybeLoadMore);
          }

          btns.forEach(function(btn) {
            if (panel) {
              btn.addEventListener('click', function() {
                if (panel.classList.contains('open')) {
                  closePanel();
                } else {
                  openPanel();
                }
              });
            }
          });
          if (closeBtn) { closeBtn.addEventListener('click', closePanel); }
          if (toggle) {
            toggle.addEventListener('change', function() {
              localStorage.setItem('inboxShowRead', toggle.checked ? '1' : '0');
              loadInbox();
            });
          }

          updateInboxBadge();

          if (panel && btns.length > 0 && localStorage.getItem('inboxOpen') === '1') {
            panel.classList.add('open');
            loadInbox();
          } else if (btns.length === 0) {
            localStorage.removeItem('inboxOpen');
          }
        });
      }
    </script>

    <main>
      <%= yield %>
    </main>

    <footer style="text-align: center; padding: 1rem 1rem; color: var(--color-text); border-top: 1px solid var(--color-border); margin-top: auto; font-size: 0.875em;">
      <p style="display: flex; align-items: center; justify-content: center; gap: 0.5em; margin: 0;">
        <a href="https://github.com/sh1nj1/plan42" target="_blank" class="unstyled-link" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.25em;">
          <svg height="16" width="16" viewBox="0 0 16 16" version="1.1" aria-hidden="true" style="fill: currentColor;">
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          GitHub
        </a> |
        <%=t('app.name')%> (Demo) by VReRV
      </p>
    </footer>

    <script>
      document.addEventListener('turbo:load', function() {
        var links = document.querySelectorAll('.creative-guide-link');
        var popover = document.getElementById('creative-guide-popover');
        var close = document.getElementById('close-creative-guide');
        if (links.length && popover && close) {
          links.forEach(function(link) {
            link.addEventListener('click', function(e) {
              if (link.dataset.helpUrl) {
                window.location.href = link.dataset.helpUrl;
                return;
              }
              e.preventDefault();
              popover.style.display = 'block';
            });
          });
          close.addEventListener('click', function() {
            popover.style.display = 'none';
          });
          document.addEventListener('click', function(e) {
            if (!popover.contains(e.target) && !Array.from(links).includes(e.target)) {
              popover.style.display = 'none';
            }
          });
        }
      });
    </script>
    <%= render "comments/reaction_picker" %>
  </body>
</html>
