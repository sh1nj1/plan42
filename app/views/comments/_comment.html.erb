<div class="comment-item" id="<%= dom_id(comment) %>" data-controller="comment" data-user-id="<%= comment.user&.id %>" data-comment-id="<%= comment.id %>">
  <div class="comment-select">
    <input type="checkbox"
           class="comment-select-checkbox"
           value="<%= comment.id %>"
           aria-label="<%= t('comments.select_label') %>" />
  </div>
  <% attachments_data = comment.images.map { |image| { signed_id: image.blob.signed_id, filename: image.filename.to_s } } %>
  <div>
    <%= render AvatarComponent.new(user: comment.user, size: 20, classes: 'avatar comment-avatar') %>
    <% system_prefix = "#{t('comments.system_user')}:" %>
    <% display_name =
         if comment.user.present?
           comment.user.display_name
         elsif comment.content.to_s.strip.start_with?(system_prefix)
           t('comments.system_user')
         else
           t('comments.gemini')
         end %>
    <% timestamp = comment.created_at.in_time_zone %>
    <strong><%= display_name %></strong>
    <span>
      Â· <%= content_tag(
        :time,
        t('datetime.ago', time: time_ago_in_words(timestamp)),
        title: l(timestamp, format: :chat_timestamp),
        datetime: timestamp.iso8601
      ) %>
    </span>
    <span id="read_receipts_comment_<%= comment.id %>" class="read-receipt-wrapper">
      <% users_read = defined?(read_by_users) ? read_by_users : (defined?(read_receipts) ? read_receipts[comment.id] : nil) %>
      <%= render "comments/read_receipts", read_by_users: users_read unless comment.private? %>
    </span>
    <% if comment.private? %>
      <span class="private-label">[<%= t('comments.private') %>]</span>
    <% end %>
    <% if comment.action_executed_at.present? %>
      <span class="comment-status-label approved-label">[<%= t('comments.approved_label') %>]</span>
    <% end %>
    <% can_convert_comment = comment.user == Current.user || comment.creative.has_permission?(Current.user, :admin) %>
    <div class="comment-action-container">

      <button class="<%= ['convert-comment-btn', ('comment-owner-only' unless can_convert_comment)].compact.join(' ') %>" data-comment-target="ownerButton" data-comment-id="<%= comment.id %>" title="<%= t('comments.convert_to_creative') %>">
        <%= t('comments.convert_button') %>
      </button>
      <% if comment.action.present? && comment.approver == Current.user %>
        <button class="approve-comment-btn" data-comment-id="<%= comment.id %>" title="<%= t('comments.approve_button') %>">
          <%= t('comments.approve_button') %>
        </button>
      <% end %>
      <button class="edit-comment-btn comment-owner-only"
              data-comment-target="ownerButton"
              data-comment-id="<%= comment.id %>"
              data-comment-content="<%= comment.content %>"
              data-comment-private="<%= comment.private? %>"
              data-comment-attachments="<%= attachments_data.to_json %>"
              title="<%= t('comments.update_comment') %>">
        <%= t('comments.edit_button') %>
      </button>
      <button class="copy-comment-link-btn" data-comment-id="<%= comment.id %>" data-comment-url="<%= creative_comment_url(comment.creative, comment) %>" title="<%= t('comments.copy_link_button') %>">
        <%= t('comments.copy_link_button') %>
      </button>
      <% can_delete = comment.user == Current.user || comment.creative.user == Current.user || comment.creative.has_permission?(Current.user, :admin) %>
      <% if can_delete %>
        <button class="delete-comment-btn" data-comment-id="<%= comment.id %>" title="<%= t('comments.delete') %>">
          <%= t('comments.delete_button') %>
        </button>
      <% end %>
    </div>
  </div>
  <div class="comment-content"><%= comment.content %></div>
  <% if comment.images.attached? %>
    <div class="comment-attachments">
      <% comment.images.each do |image| %>
        <% preview_image = image.variable? ? image.variant(resize_to_limit: [ 800, 800 ]) : image %>
        <% preview_image_path =
             if preview_image.respond_to?(:processed)
               rails_representation_path(preview_image, only_path: true)
             else
               rails_blob_path(preview_image, only_path: true)
             end %>
        <%= link_to rails_blob_path(image, only_path: true), target: '_blank', rel: 'noopener', class: 'comment-attachment-link', data: { attachment_signed_id: image.blob.signed_id, attachment_filename: image.filename.to_s } do %>
          <%= image_tag preview_image_path, class: 'comment-attachment-image', alt: '', loading: 'lazy' %>
        <% end %>
      <% end %>
    </div>
  <% end %>
  <% if comment.action.present? %>
    <div class="comment-action-block" data-comment-id="<%= comment.id %>">
      <details class="comment-action-details">
        <summary class="comment-action-summary"><%= t("comments.action_summary") %></summary>
        <div class="comment-action-body">
          <pre class="comment-action-json" data-comment-action-json><%= formatted_comment_action(comment) %></pre>
          <% if comment.approver == Current.user && comment.action_executed_at.blank? %>
            <button class="edit-comment-action-btn" type="button" data-comment-id="<%= comment.id %>"><%= t("comments.edit_action_button") %></button>
            <form class="comment-action-edit-form" data-comment-id="<%= comment.id %>" style="display:none;">
              <textarea class="comment-action-edit-textarea" name="comment[action]" rows="8"><%= formatted_comment_action(comment) %></textarea>
              <div class="comment-action-edit-buttons">
                <button class="cancel-comment-action-edit-btn" type="button"><%= t("app.cancel") %></button>
                <button class="save-comment-action-btn" type="submit"><%= t("app.save") %></button>
              </div>
            </form>
          <% end %>
        </div>
      </details>
    </div>
  <% end %>
  <% if comment.activity_logs.exists? %>
    <div class="comment-activity-log-block">
      <details>
        <summary><%= t("comments.activity_logs_summary") %></summary>
        <%= turbo_frame_tag "activity_log_details_#{comment.id}", src: creative_comment_activity_log_path(comment.creative, comment), loading: "lazy" do %>
          Loading...
        <% end %>
      </details>
    </div>
  <% end %>


</div>
