<h1 class="text-center" style="margin-top: 0;"><%= t('users.new_ai.title') %></h1>

<%= form_with url: create_ai_users_path, class: "stacked-form" do |form| %>
  <div class="form-group">
    <%= form.label :ai_id, t('users.new_ai.id_label') %>
    <%= form.text_field :ai_id, required: true, class: "stacked-form-control", placeholder: "e.g. my_bot" %>
  </div>

  <div class="form-group">
    <%= form.label :name, t('users.new_ai.name_label') %>
    <%= form.text_field :name, required: true, class: "stacked-form-control", placeholder: "e.g. My Bot" %>
  </div>

  <div class="form-group">
    <%= form.label :system_prompt, t('users.new_ai.system_prompt_label') %>
    <%= form.text_area :system_prompt, required: true, class: "stacked-form-control", rows: 5, value: AiClient::SYSTEM_INSTRUCTIONS %>
  </div>

  <div class="form-group">
    <%= form.label :routing_expression, "Routing Expression (Liquid)" %>
    <%= form.text_area :routing_expression, class: "stacked-form-control", rows: 2, placeholder: "chat.mentioned_user.id == agent.id" %>
    <small class="form-text text-muted">Liquid expression to determine if this agent should handle an event. Example: <code>chat.mentioned_user.id == agent.id</code></small>
  </div>

  <div class="form-group">
    <%= form.label :llm_model, t('users.new_ai.model_label') %>
    <div style="position: relative;"
         data-controller="llm-model"
         data-llm-model-menu-id-value="llm-model-suggestions"
         data-llm-model-models-value="<%= User::SUPPORTED_LLM_MODELS.to_json %>">
      <%= form.text_field :llm_model,
                          required: true,
                          class: "stacked-form-control",
                          autocomplete: "off",
                          data: {
                            llm_model_target: "input",
                            action: "input->llm-model#search focus->llm-model#focus blur->llm-model#blur keydown->llm-model#handleKeydown"
                          } %>
      <%= render UserMentionMenuComponent.new(menu_id: 'llm-model-suggestions') %>
    </div>
  </div>

  <div class="form-group">
    <%= form.label :llm_api_key, t('users.new_ai.api_key_label') %>
    <%= form.password_field :llm_api_key, class: "stacked-form-control", placeholder: "sk-..." %>
    <small class="form-text text-muted"><%= t('users.new_ai.api_key_help') %></small>
  </div>

  <div class="form-group">
    <label class="form-label"><%= t('users.edit_ai.tools_title') %></label>
    <p class="text-muted small"><%= t('users.edit_ai.tools_description') %></p>
    
    <% if @available_tools.any? %>
      <div class="tools-selection">
        <% @available_tools.each do |tool| %>
          <div class="form-check mb-2">
            <%= check_box_tag "tools[]", tool[:name], false, id: "tool_#{tool[:name]}", class: "form-check-input" %>
            <label class="form-check-label" for="tool_<%= tool[:name] %>">
              <strong><%= tool[:name] %></strong>
              <br>
              <span class="text-muted small"><%= tool[:description] %></span>
            </label>
            <details class="ml-4">
              <summary class="text-muted small" style="cursor: pointer;">Parameters</summary>
              <pre class="small bg-light p-2 mt-1"><code><%= JSON.pretty_generate(tool[:parameters]) %></code></pre>
            </details>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-muted"><%= t('users.edit_ai.no_tools_found') %></p>
    <% end %>
  </div>

  <div class="form-group">
    <div class="form-check">
      <%= form.check_box :searchable, { class: "form-check-input" }, true, false %>
      <%= form.label :searchable, t('users.new_ai.searchable_label'), class: "form-check-label" %>
    </div>
    <small class="form-text text-muted"><%= t('users.new_ai.searchable_help') %></small>
  </div>

  <%= form.button t('users.new_ai.submit'), type: "submit", class: "primary-action-button" %>
<% end %>

<br/>
<%= link_to t('common.cancel'), user_path(Current.user, tab: 'contacts'), class: "text-center block" %>
