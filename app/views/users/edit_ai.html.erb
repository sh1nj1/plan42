<h1 class="text-center" style="margin-top: 0;"><%= t('users.edit_ai.title') %></h1>

<%= form_with model: @user, url: update_ai_user_path(@user), method: :patch, class: "stacked-form" do |form| %>
  <div class="form-group">
    <%= form.label :name, t('users.new_ai.name_label') %>
    <%= form.text_field :name, required: true, class: "stacked-form-control", placeholder: "e.g. My Bot" %>
  </div>

  <div class="form-group">
    <%= form.label :system_prompt, t('users.new_ai.system_prompt_label') %>
    <%= form.text_area :system_prompt, required: true, class: "stacked-form-control", rows: 5 %>
  </div>

  <div class="form-group">
    <%= form.label :routing_expression, "Routing Expression (Liquid)" %>
    <%= form.text_area :routing_expression, class: "stacked-form-control", rows: 2, placeholder: "chat.mentioned_user.id == agent.id" %>
    <small class="form-text text-muted">Liquid expression to determine if this agent should handle an event. Example: <code>chat.mentioned_user.id == agent.id</code></small>
  </div>

  <div class="form-group">
    <%= form.label :llm_model, t('users.new_ai.model_label') %>
    <%= form.select :llm_model, User::SUPPORTED_LLM_MODELS, {}, class: "stacked-form-control" %>
  </div>

  <div class="form-group">
    <%= form.label :llm_api_key, t('users.new_ai.api_key_label') %>
    <%= form.password_field :llm_api_key, class: "stacked-form-control", placeholder: "sk-...", value: @user.llm_api_key %>
    <small class="form-text text-muted"><%= t('users.new_ai.api_key_help') %></small>
  </div>

  <div class="form-group">
    <label class="form-label"><%= t('users.edit_ai.tools_title') %></label>
    <p class="text-muted small"><%= t('users.edit_ai.tools_description') %></p>
    
    <% if @available_tools.any? %>
      <div class="tools-selection">
        <% @available_tools.each do |tool| %>
          <div class="form-check mb-2">
            <%= check_box_tag "user[tools][]", tool[:name], (@user.tools || []).include?(tool[:name]), id: "tool_#{tool[:name]}", class: "form-check-input" %>
            <label class="form-check-label" for="tool_<%= tool[:name] %>">
              <strong><%= tool[:name] %></strong>
              <br>
              <span class="text-muted small"><%= tool[:description] %></span>
            </label>
            <details class="ml-4">
              <summary class="text-muted small" style="cursor: pointer;">Parameters</summary>
              <pre class="small bg-light p-2 mt-1"><code><%= JSON.pretty_generate(tool[:parameters]) %></code></pre>
            </details>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-muted"><%= t('users.edit_ai.no_tools_found') %></p>
    <% end %>
  </div>

  <div class="form-group">
    <div class="form-check">
      <%= form.check_box :searchable, { class: "form-check-input" }, true, false %>
      <%= form.label :searchable, t('users.new_ai.searchable_label'), class: "form-check-label" %>
    </div>
    <small class="form-text text-muted"><%= t('users.new_ai.searchable_help') %></small>
  </div>

  <%= form.button t('common.save'), type: "submit", class: "primary-action-button" %>
<% end %>
