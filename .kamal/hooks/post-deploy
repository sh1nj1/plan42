#!/bin/sh
set -eu

# Derive SSH settings (override via env vars):
SSH_USER="${KAMAL_SSH_USER:-deploy}"          # e.g. deploy, ubuntu, ec2-user
SSH_PORT="${KAMAL_SSH_PORT:-22}"
SSH_KEY="${KAMAL_SSH_IDENTITY:-$HOME/.ssh/id_rsa}"  # or path you load in CI
SSH_OPTS="-p ${SSH_PORT} -i ${SSH_KEY} -o StrictHostKeyChecking=accept-new"

# If docker requires sudo on the hosts, set REMOTE_PREFIX="sudo " (include space)
REMOTE_PREFIX="${REMOTE_PREFIX:-}"    # e.g. export REMOTE_PREFIX="sudo "

# Kamal provides CSV; normalize to space-separated
HOSTS="$(echo "${KAMAL_HOSTS:-}" | tr ',' ' ' | tr -s ' ')"

[ -n "$HOSTS" ] || { echo "No KAMAL_HOSTS provided"; exit 1; }

for host in $HOSTS; do
  # Allow hosts to be specified as bare host or user@host; only prepend user if absent
  case "$host" in
    *@*) TARGET="$host" ;;
    *)   TARGET="${SSH_USER}@${host}" ;;
  esac

  echo "Pruning unused Docker resources on ${TARGET}..."
  ssh $SSH_OPTS "$TARGET" "${REMOTE_PREFIX}docker system prune -af --volumes"
done
